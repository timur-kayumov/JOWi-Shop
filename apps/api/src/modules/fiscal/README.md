# Fiscal Module

This module provides fiscal device integration for Uzbekistan fiscalization compliance.

## Current Implementation

Currently using **MockFiscalProvider** for development purposes. This mock provider simulates fiscal device behavior without requiring actual hardware.

## Fiscal Operations

The fiscal provider supports the following operations:

1. **openShift()** - Open a new cashier shift
2. **registerSale()** - Register a sale and get fiscal receipt
3. **refund()** - Process a refund
4. **printXReport()** - Print shift summary (without closing)
5. **closeShift()** - Close shift and print Z-report
6. **getStatus()** - Check fiscal device status

## Usage Example

```typescript
import { Inject } from '@nestjs/common';
import { IFiscalProvider } from './fiscal-provider.interface';

@Injectable()
export class SalesService {
  constructor(
    @Inject('FISCAL_PROVIDER')
    private readonly fiscalProvider: IFiscalProvider
  ) {}

  async processSale(items, payments) {
    // Open shift if needed
    const status = await this.fiscalProvider.getStatus();

    // Register sale
    const fiscalReceipt = await this.fiscalProvider.registerSale({
      items,
      payments,
      cashierName: 'John Doe',
    });

    // Save fiscal data to database
    // ...
  }
}
```

## Implementing a Real Fiscal Provider

To integrate a real fiscal device (Shtrih, ATOL, Payme-POS, etc.):

1. Create a new provider class in `providers/` directory
2. Implement the `IFiscalProvider` interface
3. Update `fiscal.module.ts` to use your provider:

```typescript
{
  provide: 'FISCAL_PROVIDER',
  useClass: YourRealFiscalProvider, // Replace MockFiscalProvider
}
```

## Supported Devices (Future)

- **Shtrih-M** - Russian fiscal registers
- **ATOL** - Popular fiscal devices
- **Payme-POS** - Uzbekistan payment terminal with fiscal support
- **Custom TCP/IP** - Generic implementation for network-connected devices

## Error Handling

All fiscal operations can throw `FiscalProviderError` with specific error codes:

- `DEVICE_OFFLINE` - Fiscal device not responding
- `SHIFT_NOT_OPENED` - Operation requires an open shift
- `SHIFT_EXPIRED` - Shift exceeded 24-hour limit
- `INVALID_REQUEST` - Invalid data in request
- `COMMUNICATION_ERROR` - Network/communication error
- `FISCAL_MEMORY_FULL` - Device memory full

## Testing

The mock provider is automatically used in test environments. No additional configuration needed.

## Production Deployment

1. Install fiscal device SDK/drivers
2. Configure device connection (COM port, IP address, etc.)
3. Set environment variables for device settings
4. Replace MockFiscalProvider with real implementation
5. Test thoroughly with actual fiscal device before going live

## Compliance Notes

- All sales MUST be fiscalized for Uzbekistan compliance
- Receipts must include QR code (generated by fiscal device)
- Shift duration limited to 24 hours maximum
- Fiscal storage must be regularly backed up
- Z-reports must be sent to tax authorities (FTS)
