POS-клиент (точка продаж)

Платформа POS: Кассовое приложение реализуется как мобильное приложение для Android планшетов, созданное с использованием Flutter (кроссплатформенный фреймворк от Google). Приложение ориентировано на планшеты с диагональю 10"+ (например, Samsung Tab A8 и аналогичные), работающие под управлением Android 11 (API 30) или выше. Минимальные требования к устройству: 4GB RAM, 32GB хранилища.

Flutter позволяет создавать нативные мобильные приложения с высокой производительностью, используя язык программирования Dart. Приложение получает доступ к локальным ресурсам Android (файловая система, Bluetooth, USB OTG, камера) через нативные API и платформенные каналы (Platform Channels), что обеспечивает интеграцию с торговым оборудованием (принтеры, сканеры, фискальные устройства).

Преимущества Flutter/Android для POS:
- Мобильность: планшеты легко перемещаются по торговому залу
- Стоимость оборудования: Android планшеты в 2-3 раза дешевле Windows-терминалов
- Производительность: нативная компиляция обеспечивает быстрый запуск и отклик
- Батарея: возможность работы от аккумулятора (для мобильных точек продаж)
- Сенсорный интерфейс: Material Design оптимизирован для touch-интерфейса

Оффлайн-режим: Критическое требование – POS должен работать без постоянного интернета. Все основные операции (регистрация продаж, возвратов, открытие/закрытие смен) выполняются локально даже при отсутствии сети. Для этого в POS-клиенте используется локальная база данных для хранения настроек, каталога товаров и очереди транзакций.

Локальное хранилище данных: Для обеспечения высокой производительности при работе с большими каталогами (50,000-200,000 товаров) используется база данных Isar – высокопроизводительная NoSQL база для Flutter, работающая в 10 раз быстрее sqflite. Альтернатива – drift (type-safe SQL) для сложных реляционных запросов.

Оптимизация производительности для больших каталогов:
- Индексы на barcode, name, category для быстрого поиска
- Lazy loading товаров (подгрузка по мере прокрутки)
- Виртуализация списков (отображение только видимых элементов)
- Debounce поиска (задержка 300ms перед запросом)
- In-memory кеш для популярных товаров (топ-100 по продажам)
- Серверный поиск как fallback для редких товаров

При появлении интернета происходит синхронизация с облаком: продажи и другие изменения, сделанные оффлайн, отправляются на сервер, и наоборот – обновления (например, новые товары или изменения цен, проведённые через веб-интерфейс) загружаются на клиент.

Реализован механизм Outbox/Inbox: на POS изменения пишутся в локальный Outbox, а фоновые задачи отправляют их на сервер. Серверные обновления кладутся в локальный Inbox для применения на клиенте.

Фоновая синхронизация: Используется WorkManager (Android Background Work API) для надежной фоновой синхронизации. Синхронизация запускается:
- При подключении к интернету (после периода offline)
- Каждые 15 минут при наличии сети
- Вручную по запросу пользователя (кнопка "Синхронизировать")

Изоляция задач: Синхронизация выполняется в отдельном isolate (Dart concurrency), не блокируя основной UI поток, что обеспечивает плавность интерфейса даже во время синхронизации больших объемов данных.

Конфликты решаются по принципу «last write wins» для продаж (последняя операция считается актуальной, хотя обычно конфликты маловероятны для транзакций продаж) и по определённым правилам для справочников (например, если один товар параллельно редактировали на двух кассах, сервер может оставить последнюю версию или объединить изменения полей, если они разные).

Такой подход аналогичен решениям конкурентов, где POS продолжает работу даже без интернета
moysklad.uz
, обеспечивая непрерывность продаж.

Интерфейс и UX кассы:

POS-интерфейс должен быть максимально простым и быстрым для кассира. Операции продажи должны выполняться минимальным числом кликов/действий.

Сканирование штрих-кодов: Поддерживаются два способа сканирования:

1. **USB сканеры** (keyboard wedge режим): Сканер подключается к планшету через USB OTG адаптер и работает как клавиатура. При сканировании фокус автоматически переходит на скрытое поле ввода, товар мгновенно добавляется в чек. Кассира не отвлекает курсор или поле ввода.

2. **Камера планшета** (опционально): Используется пакет `mobile_scanner` для сканирования штрих-кодов камерой планшета. Кассир может нажать кнопку "Сканировать" и навести камеру на товар. Этот режим полезен для точек без отдельного сканера или для редких товаров без штрих-кода.

Поддерживаемые форматы: EAN-13, EAN-8, Code-128, QR-коды (для DataMatrix маркировки).

Горячие клавиши: Поддержка внешней клавиатуры (подключаемой через USB OTG или Bluetooth) с сочетаниями клавиш для основных действий:
- F1 - Новый чек
- F2 - Поиск товара
- F3 - Применить скидку
- F4 - Выбор способа оплаты
- F5 - Печать копии чека
- F12 - Настройки
- Esc - Отмена/назад

Это позволяет опытным кассирам работать не используя сенсорный экран. Особое внимание – работе с клавиатурой, т.к. многие кассиры предпочитают быстрые нажатия клавиш.

Макет экрана: На экране кассы должно отображаться:

Список товаров в текущем чеке (с ценами, количеством, суммами и скидками) – обычно справа либо снизу, чтобы постоянно быть на виду.

Область поиска/сканирования товара и быстрые кнопки товарных категорий или популярных товаров – слева, для добавления позиций.

Итоги по чеку (итого, скидки, налоги) и выбранный способ оплаты – обычно внизу, крупно выделено.

Кнопки действий: Завершить продажу, Отмена/очистка чека, Применить скидку, Возврат и т.п. – крупные кнопки, удобные для тач-экрана.

Быстрые операции: Добавить поддержку быстрого сканирования дисконтной карты клиента (или ввода номера телефона) для применения программы лояльности, быстрый ввод суммы наличными (например, кнопки "50,000 сум", "100,000 сум" для быстрого выбора сдачи).

Удобство для кассира: Интерфейс кассы спроектирован для сенсорных экранов согласно Material Design 3 guidelines:
- Минимальный размер интерактивных элементов – 48x48dp (Material Design стандарт)
- Адаптивная вёрстка для различных размеров планшетов (10", 11", 12", 13")
- Портретная и ландшафтная ориентация (рекомендуется ландшафтная для POS)
- Цветовая схема – нейтральная, не утомляющая глаза при длительной работе
- Поддержка ночного режима (dark theme) для работы вечером/ночью
- Крупные шрифты (минимум 16sp для основного текста, 20sp для цен)
- Высокий контраст (contrast ratio ≥4.5:1) для читаемости

Поддержка оборудования: POS-клиент интегрируется с торговым оборудованием через Android API и платформенные каналы (Platform Channels):

**Фискальный регистратор:**
- **Опция A (рекомендуется для MVP):** Подключение через fiscal-gateway REST API – фискальное устройство подключено к отдельному серверу/компьютеру, POS отправляет HTTP запросы на fiscal-gateway для печати чеков. Это обеспечивает гибкость и независимость от наличия Android SDK от производителя.
- **Опция B (будущее):** Прямое подключение к фискальному устройству через USB OTG, Bluetooth или Network (если производитель предоставит Android SDK). Требуется native Kotlin/Java код (Platform Channel) для вызова SDK.
- Поддержка ESC/POS команд для печати чеков на 58мм или 80мм термоленте.
- Для Узбекистана – интеграция с устройствами, сертифицированными по местным стандартам (Shtrih, ATOL, Payme-POS).

**Термопринтер чеков (без фискализации):**
- **Bluetooth принтеры:** Используются пакеты `esc_pos_bluetooth` или `blue_thermal_printer` для беспроводной печати. Рекомендуется для небольших точек и мобильных продаж.
- **Network принтеры (WiFi/Ethernet):** Используется пакет `esc_pos_printer` для подключения по IP адресу. Рекомендуется для стационарных точек.
- **USB принтеры:** Подключение через USB OTG кабель с использованием `usb_serial` или Platform Channels.
- Автоматическое обнаружение принтеров: Bluetooth scan, mDNS для network принтеров, manual IP entry.

**Сканер штрих-кодов:**
- **USB сканеры:** Подключаются через USB OTG адаптер, работают в keyboard wedge режиме (как клавиатура). Нативная поддержка Android без дополнительного кода.
- **Bluetooth сканеры:** Подключаются как Bluetooth HID устройство.
- **Камера планшета:** Пакет `mobile_scanner` для сканирования 1D/2D штрих-кодов.

**Денежный ящик:**
- Открытие ящика через команду ESC/POS принтера (kick-out pulse). Обычно денежный ящик подключен к принтеру чеков.
- Опционально: прямое подключение через Platform Channel при наличии API.

**Электронные весы (опционально):**
- Интеграция с весами через Bluetooth или USB.
- Считывание веса товара в реальном времени.
- Обработка штрих-кода с весовым кодом (первые цифры = код товара, последние = вес).

**Платёжный терминал:**
- **MVP:** Ручной ввод – кассир вручную пробивает сумму на банковском терминале и вводит результат в POS.
- **Будущее:** Интеграция с Payme, Click через REST API для автоматической отправки суммы на терминал по локальной сети или через облачный API.
- **NFC платежи (будущее):** Использование пакета `flutter_nfc_kit` для бесконтактных платежей, если планшет поддерживает NFC.

Обновления и поддержка: POS-клиент получает обновления с минимальным участием пользователя.

**Стратегия обновлений:**

**Опция A: Google Play Store (рекомендуется для production):**
- Автоматические обновления через Google Play Store.
- Тестирование новых версий через Internal Testing (команда разработки) → Closed Beta (пилотные магазины) → Production (все пользователи).
- Откат к предыдущей версии через Play Console при обнаружении критических багов.
- Пользователь получает уведомление "Обновление доступно", может установить сейчас или отложить.

**Опция B: Manual APK Distribution (для MVP/тестирования):**
- Приложение проверяет наличие обновлений на сервере при запуске и каждые 4-6 часов.
- При обнаружении новой версии скачивает APK в фоновом режиме.
- После загрузки показывает уведомление: "Обновление готово к установке".
- Кассир может установить обновление сейчас или отложить (например, до закрытия смены).
- Критические обновления (security, fiscal compliance) помечаются как обязательные и устанавливаются принудительно при закрытии смены.

**Offline considerations:**
- Если планшет offline, проверка обновлений пропускается.
- При появлении интернета проверка возобновляется автоматически.
- Приложение продолжает работать на текущей версии без ограничений.

**Миграции базы данных:**
- При установке новой версии приложение автоматически проверяет совместимость схемы локальной базы.
- Применяет миграции Isar/drift для обновления структуры данных.
- В случае ошибки миграции показывает сообщение и предлагает связаться с поддержкой (откат не производится автоматически во избежание потери данных).