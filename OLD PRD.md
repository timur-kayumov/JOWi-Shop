## PRD v1 (с учётом ответов)

**География/валюта**: Узбекистан, валюта UZS.
**Фискализация**: Да. Абстракция FiscalProvider с адаптерами под локальные онлайн‑кассы/принтеры. Очередь на фискализацию с ретраями.
**Многоарендность**: SaaS. Иерархия: Бизнес → Магазин → Терминал/Касса. Разделение данных по tenant_id + RLS.
**POS‑клиент**: Windows desktop (Electron) с оффлайн‑режимом. Локальный стор (SQLite + WAL). Двусторонняя синхронизация с сервером по очереди изменений.
**Каталог**: SKU с вариантами (цвет/размер и т.п.), баркоды, единицы измерения, НДС. Комплекты и серийники опционально.
**Цены/промо**: Базовые скидки по правилам на позицию/чек. Лояльность через интеграцию с JOWi Club (REST/Webhook). Баллы/уровни хранятся в JOWi Club, в JOWi Shop — транзакционный журнал.
**Склад**: Приход, перемещения, возврат поставщику, инвентаризация (циклическая), партии/себестоимость FIFO.
**Финансы**: Кассовые смены, платежи (нал, эквайринг, перевод), кассовая книга, взаиморасчёты с поставщиками/клиентами. Бухгалтерская интеграция не требуется. Все операции формируют проводки в собственной подсистеме.
**Отчёты**: Продажи по периодам/часам/товарам, эффективность сотрудников, остатки. Масштабируемая витрина для добавления новых отчётов.
**Доступы**: Роли по умолчанию: Администратор, Управляющий, Продавец, Складской. Расширяемая RBAC.
**Интеграции**: JOWi Club; будущие маркетплейсы через Integration Hub.
**Локализация**: RU и UZ. Переключение языка на уровне пользователя и магазина.
**Неготово в MVP**: Маркетплейсы, сложные промо‑движки, рецептуры.
**Метрики MVP**: Время оформления чека, стабильность оффлайн‑продаж, % успешной синхронизации, время инвентаризации.

## Архитектура (уточнённая)

* **Desktop POS**: Electron + React + Vite. Общая UI‑библиотека с вебом.
* **Веб‑админ**: Next.js (App Router) + React.
* **UI**: Tailwind CSS + shadcn/ui + Radix. Общий пакет `@jowi/ui`.
* **Бэкенд**: NestJS (HTTP + tRPC‑подобные контракты), Zod для схем, Prisma.
* **OLTP**: PostgreSQL. RLS per‑tenant. Миграции — Prisma + dbmate.
* **Оффлайн/синхронизация**: Локальная SQLite в POS. Outbox/Inbox очереди, идемпотентные команды. Конфликты: last‑write‑wins для продаж, merge‑правила для справочников.
* **Фискализация**: Сервис `fiscal-gateway` c драйверами провайдеров. Интерфейсы: `openShift()`, `registerSale()`, `refund()`, `closeShift()`.
* **Очереди/кеш**: Redis. Брокер событий NATS (опц.).
* **Аналитика**: ClickHouse для отчётов. CDC из Postgres (Debezium) → Kafka/NATS → CH.
* **Auth**: Auth.js/Clerk, JWT с привязкой к tenant_id, 2FA.
* **Observability**: OpenTelemetry + Grafana/Loki/Tempo. Audit log неизменяемый.

## Доменная модель (срез MVP)

Бизнес, Магазин, Терминал, Сотрудник, Роль, Смена; Клиент; Товар, Вариант(SKU), Баркод, Категория, НДС; Склад, Остаток, Партия, Документы движения; Чек, Позиция, Скидка, Оплата; Проводка, Кассовая операция; Интеграция (JOWi Club).

## Design Guidelines для Claude Code

**Цель**: единый, предсказуемый UI без Figma, код — источник истины.

1. **Токены**: цветовая схема через CSS‑переменные. Темы light/dark. Шрифты системные.
2. **Сетка**: контейнер 1200–1440px, 8‑pt spacing, min touch target 40px.
3. **Компоненты (из `@jowi/ui`)**: AppShell, Sidebar, Topbar, DataTable, Form, Input, Select, DatePicker, Dialog, Drawer, Toast, Tabs, Wizard, KPI‑Cards, Chart primitives.
4. **Таблицы**: TanStack Table, серверная пагинация, виртуализация, колонковые фильтры, экспорт CSV.
5. **Формы**: React Hook Form + Zod. Единый `FormField` и `FormDialog`.
6. **Состояния**: empty, loading, error стандартизированы. Спиннер и скелетоны общие.
7. **i18n**: i18next, неймспейсы `common`, `pos`, `inventory`, `finance`. Текст только из словарей.
8. **Иконки**: lucide-react. Размеры 16/20/24.
9. **Доступность**: все интерактивы на Radix, фокус‑кольца включены, контраст ≥4.5.
10. **Диаграммы**: Recharts, минимальный набор: Bar, Line, Pie. Легенда и тултипы по умолчанию.
11. **POS‑поток**: горячие клавиши, сканер как ввод, крупные цели, чек справа, быстрые скидки.
12. **Печать чеков**: шаблоны ESC/POS. Шрифт моно, ширина 48 символов.
