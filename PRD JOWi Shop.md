# PRD v1.1 (обновлённый)

## География и валюты
- Узбекистан  
- Валюта: UZS  
- Мультивалютность: не требуется  

## Фискализация
- Обязательна.  
- Используется абстракция `FiscalProvider` с адаптерами под локальные онлайн-кассы и фискальные принтеры (Shtrih, ATOL, Payme-POS и т.д.).  
- Реализуется очередь на фискализацию с ретраями и логом ошибок.  
- Автоматическое восстановление после сбоя связи.  
- Поддержка печати чеков возврата и X/Z-отчётов.  

## Многоарендность
- SaaS-архитектура.  
- Иерархия: **Бизнес → Магазин → Терминал (касса)**.  
- Разделение данных по `tenant_id` + RLS (Row-Level Security).  
- Централизованная панель управления арендаторами (для JOWi Admin).  

## POS-клиент
- Платформа: **Windows (Electron desktop)**.  
- Работает в оффлайн-режиме с локальной базой данных (SQLite + WAL).  
- Поддержка сканеров штрих-кодов, горячих клавиш и сенсорного интерфейса.  
- Синхронизация данных по очереди изменений (Outbox/Inbox).  
- Приоритет последней записи (`last-write-wins`) для продаж, merge-стратегия для справочников.  
- Поддержка локальной печати чеков (ESC/POS).  
- Управление версиями и автообновление клиента.  

## Каталог
- Поддержка товаров и вариантов (SKU): цвет, размер, фасовка и т.п.  
- Баркоды, единицы измерения, категории, НДС.  
- Поддержка комплектов (bundle) и серийных номеров.  
- Массовый импорт/экспорт (CSV/Excel).  
- Ценовые группы (розничная, оптовая, спец-цена).  

## Цены и промо
- Базовые скидки по правилам (на позицию, на чек, по времени, по категории).  
- Настройка акций с периодом действия и приоритетами.  
- Интеграция с **JOWi Club**: REST/Webhook-интерфейс для начисления и списания баллов.  
- Хранение всех транзакций лояльности в журнале `LoyaltyTransaction`.  
- Поддержка купонов и промо-кодов (в будущем).  

## Склад
- Документы движения: приход, перемещение, возврат поставщику, списание, инвентаризация.  
- Учёт по партиям (FIFO).  
- Автоматическое обновление себестоимости и остатков.  
- Циклическая инвентаризация с возможностью частичного пересчёта.  
- История движений по каждому товару.  
- Поддержка уведомлений о минимальных остатках.  

## Финансы
- Кассовые смены и операции.  
- Типы платежей: наличные, эквайринг, перевод, рассрочка.  
- Кассовая книга (вход/выход).  
- Учёт взаиморасчётов с поставщиками и клиентами.  
- Подсистема проводок (внутренний бухгалтерский контур).  
- Отражение всех движений по принципу двойной записи.  
- Возможность сверки итогов по кассам и POS.  

## Отчёты и аналитика
- Базовые отчёты:
  - Продажи по дням, часам, товарам, категориям  
  - Эффективность сотрудников  
  - Остатки и обороты  
  - Сменные отчёты  
- Масштабируемая витрина: подключение новых отчётов без изменения кода ядра.  
- Экспорт в CSV/Excel.  
- Отчёты на основе ClickHouse (CDC из Postgres через Debezium → Kafka/NATS → ClickHouse).  

## Доступы и роли
- Базовые роли:
  - Администратор  
  - Управляющий  
  - Продавец  
  - Складской сотрудник  
- Реализуется RBAC (Role-Based Access Control) с расширяемыми правами.  
- Возможность настройки индивидуальных разрешений на уровне магазина и кассы.  

## Интеграции
- **JOWi Club** — программа лояльности.  
- **Integration Hub** — архитектурная точка для будущих интеграций (маркетплейсы, ERP, CRM).  
- Вебхуки на события (`sale.created`, `stock.updated`, `shift.closed`).  

## Локализация
- Поддержка **русского и узбекского языков**.  
- Переключение языка на уровне пользователя или магазина.  
- Хранение словарей в i18next-формате.  

## Не входит в MVP
- Маркетплейсы  
- Сложные промо-движки  
- Рецептуры  
- Мобильные клиенты  

## Метрики MVP
- Среднее время оформления чека  
- Стабильность оффлайн-режима  
- Процент успешной синхронизации  
- Время инвентаризации  

---

## Архитектура

### Клиенты
- **Desktop POS:** Electron + React + Vite. Общая UI-библиотека с веб-частью.  
- **Веб-админ:** Next.js (App Router) + React.  
- **UI:** Tailwind CSS + shadcn/ui + Radix. Общий пакет `@jowi/ui`.  

### Сервер
- **Backend:** NestJS (HTTP + tRPC-подобные контракты).  
- **Валидация:** Zod.  
- **ORM:** Prisma.  
- **OLTP:** PostgreSQL с RLS per-tenant.  
- **Миграции:** Prisma + dbmate.  
- **Оффлайн-синхронизация:** SQLite (локально), Outbox/Inbox очереди, идемпотентные команды.  
- **Очереди/кэш:** Redis.  
- **Брокер событий:** NATS (опционально).  
- **Фискализация:** Сервис `fiscal-gateway` с драйверами провайдеров (интерфейсы `openShift()`, `registerSale()`, `refund()`, `closeShift()`).  
- **Аналитика:** ClickHouse (через CDC).  
- **Auth:** Auth.js/Clerk, JWT с привязкой к tenant_id, поддержка 2FA.  
- **Audit log:** неизменяемый журнал действий пользователей.  
- **Observability:** OpenTelemetry + Grafana/Loki/Tempo.  

---

## Доменная модель (MVP)

- **Бизнес, Магазин, Терминал, Сотрудник, Роль, Смена**  
- **Клиент, Карта лояльности**  
- **Товар, Вариант (SKU), Баркод, Категория, НДС**  
- **Склад, Остаток, Партия, Документы движения**  
- **Чек, Позиция, Скидка, Оплата**  
- **Проводка, Кассовая операция**  
- **Интеграция (JOWi Club)**  

Дополнительно:
- **Настройки кассы** (привязка устройства, параметры печати, подключение к FiscalProvider)  
- **Права пользователя** (роль + разрешения по операциям)  
- **LoyaltyTransaction** (учёт взаимодействий с JOWi Club)  

---

## Design Guidelines для Claude Code

**Цель:** единый, предсказуемый UI без Figma. Код — источник истины.

1. **Токены:** цветовая схема через CSS-переменные. Темы light/dark. Шрифты системные.  
2. **Сетка:** контейнер 1200–1440px, 8-pt spacing, min touch target 40px.  
3. **Компоненты (`@jowi/ui`):** AppShell, Sidebar, Topbar, DataTable, Form, Input, Select, DatePicker, Dialog, Drawer, Toast, Tabs, Wizard, KPI-Cards, Chart primitives.  
4. **Таблицы:** TanStack Table, серверная пагинация, виртуализация, фильтры по колонкам, экспорт CSV.  
5. **Формы:** React Hook Form + Zod. Общие компоненты `FormField` и `FormDialog`.  
6. **Состояния:** стандартизированные empty, loading, error. Общие спиннеры и скелетоны.  
7. **i18n:** i18next, неймспейсы `common`, `pos`, `inventory`, `finance`.  
8. **Иконки:** lucide-react. Размеры 16/20/24.  
9. **Доступность:** интерактивы на Radix, фокус-кольца включены, контраст ≥4.5.  
10. **Диаграммы:** Recharts (Bar, Line, Pie). Легенда и тултипы по умолчанию.  
11. **POS-поток:** горячие клавиши, ввод со сканера, крупные цели, чек справа, быстрые скидки.  
12. **Печать чеков:** шаблоны ESC/POS, шрифт моно, ширина 48 символов.  

---
